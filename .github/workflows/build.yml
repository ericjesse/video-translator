name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: build/reports/tests/test/
          retention-days: 7

  build:
    name: Build on ${{ matrix.os }}
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact-name: linux
            build-task: packageDeb
            artifact-path: build/compose/binaries/main/deb/*.deb
          - os: macos-latest
            artifact-name: macos
            build-task: packageDmg
            artifact-path: build/compose/binaries/main/dmg/*.dmg
          - os: windows-latest
            artifact-name: windows
            build-task: packageMsi
            artifact-path: build/compose/binaries/main/msi/*.msi

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build distribution
        shell: bash
        run: ./gradlew ${{ matrix.build-task }} --no-daemon
        env:
          VERSION: ${{ steps.version.outputs.version }}

      - name: List build artifacts
        shell: bash
        run: |
          echo "Looking for artifacts..."
          find build/compose/binaries -type f \( -name "*.deb" -o -name "*.dmg" -o -name "*.msi" \) 2>/dev/null || echo "No artifacts found"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer-${{ matrix.artifact-name }}
          path: ${{ matrix.artifact-path }}
          retention-days: 30
          if-no-files-found: error

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: installer-linux
          path: artifacts/linux

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: installer-macos
          path: artifacts/macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: installer-windows
          path: artifacts/windows

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "Previous tag: $PREVIOUS_TAG"
          echo "Current tag: ${{ github.ref_name }}"

          # Generate release notes
          {
            echo "## What's Changed"
            echo ""

            if [ -n "$PREVIOUS_TAG" ]; then
              # Get commits between tags
              git log --pretty=format:"- %s (%h)" "$PREVIOUS_TAG"..HEAD --no-merges | head -50
            else
              # First release - get recent commits
              git log --pretty=format:"- %s (%h)" -20 --no-merges
            fi

            echo ""
            echo ""
            echo "## Installation"
            echo ""
            echo "### Windows"
            echo "Download and run \`VideoTranslator-${{ steps.version.outputs.version }}.msi\`"
            echo ""
            echo "### macOS"
            echo "Download \`VideoTranslator-${{ steps.version.outputs.version }}.dmg\`, open it, and drag the app to Applications"
            echo ""
            echo "### Linux (Debian/Ubuntu)"
            echo "\`\`\`bash"
            echo "sudo dpkg -i videotranslator_${{ steps.version.outputs.version }}-1_amd64.deb"
            echo "\`\`\`"
            echo ""
            echo "## Requirements"
            echo "- Java 21 or later (bundled with installers)"
            echo "- FFmpeg (will be downloaded automatically on first run)"
            echo ""
            echo "---"
            echo "*Full Changelog: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG:-initial}...${{ github.ref_name }}*"
          } > release_notes.md

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Video Translator v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            artifacts/linux/*.deb
            artifacts/macos/*.dmg
            artifacts/windows/*.msi
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    needs: [test, build, release]
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Build failed on main: ${context.sha.substring(0, 7)}`;
            const body = `
            ## Build Failure

            **Commit:** ${context.sha}
            **Author:** ${context.actor}
            **Workflow:** ${context.workflow}
            **Run:** [View details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            Please investigate and fix the failing build.
            `;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'build-failure'
            });

            const existingIssue = issues.data.find(i => i.title.includes('Build failed on main'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['build-failure', 'automated']
              });
            }
